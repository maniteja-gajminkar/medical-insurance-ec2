name: Deploy and Train

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  INSTANCE_ID: i-0ebb50246a4b9c539
  MLFLOW_PORT: 5000

jobs:
  deploy-and-train:
    runs-on: ubuntu-latest

    steps:
    - name: üßæ Checkout repository
      uses: actions/checkout@v3

    - name: üîê Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}

    - name: üöÄ Start MLflow server in background
      run: |
        aws ssm send-command \
          --document-name "AWS-RunShellScript" \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --comment "Start MLflow server" \
          --parameters 'commands=["nohup mlflow server --backend-store-uri sqlite:///mlflow.db --default-artifact-root s3://mlflow-artifacts-maniteja --host 0.0.0.0 --port ${{ env.MLFLOW_PORT }} > mlflow.log 2>&1 &"]' \
          --region ${{ env.AWS_REGION }}

    - name: üîç Check MLflow server health
      run: |
        echo "üîç Checking MLflow server at http://35.171.186.148:${{ env.MLFLOW_PORT }}"
        curl --max-time 10 -sSf "http://35.171.186.148:${{ env.MLFLOW_PORT }}" || echo "‚ö†Ô∏è MLflow server not responding"

    - name: üöÄ Trigger training on EC2 via SSM
      run: |
        aws ssm send-command \
          --document-name "AWS-RunShellScript" \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --comment "Trigger MLflow training" \
          --parameters 'commands=["export MLFLOW_TRACKING_URI=${{ secrets.MLFLOW_TRACKING_URI }} && cd /home/ec2-user/medical-insurance-ec2 && python3 train.py"]' \
          --region ${{ env.AWS_REGION }}