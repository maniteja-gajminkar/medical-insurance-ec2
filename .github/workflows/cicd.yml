name: Deploy and Train

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-and-train:
    runs-on: ubuntu-latest

    steps:
    - name: üßæ Checkout repository
      uses: actions/checkout@v3

    - name: üîê Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: üöÄ Start MLflow server in background
      run: |
        aws ssm send-command \
          --document-name "AWS-RunShellScript" \
          --instance-ids i-0ebb50246a4b9c539 \
          --comment "Start MLflow server" \
          --parameters 'commands=[
            "source /home/ec2-user/mlflow-venv/bin/activate",
            "nohup /home/ec2-user/mlflow-venv/bin/mlflow server \
              --backend-store-uri sqlite:///home/ec2-user/mlflow.db \
              --default-artifact-root s3://mlflow-artifacts-maniteja \
              --host 0.0.0.0 \
              --port 5000 > /home/ec2-user/mlflow.log 2>&1 &"
          ]' \
          --region ${{ secrets.AWS_REGION }}

    - name: üîç Check MLflow server health
      run: |
        echo "üîç Checking MLflow server at http://35.171.186.148:5000"
        curl --max-time 10 -sSf "http://35.171.186.148:5000/api/2.0/mlflow/experiments/list" || echo "‚ö†Ô∏è MLflow API not responding"

    - name: üöÄ Trigger training on EC2 via SSM
      run: |
        aws ssm send-command \
          --document-name "AWS-RunShellScript" \
          --instance-ids i-0ebb50246a4b9c539 \
          --comment "Trigger MLflow training" \
          --parameters 'commands=[
            "source /home/ec2-user/mlflow-venv/bin/activate",
            "export MLFLOW_TRACKING_URI=http://127.0.0.1:5000",
            "export AWS_REGION=${{ secrets.AWS_REGION }}",
            "cd /home/ec2-user/medical-insurance-ec2",
            "python3 train.py"
          ]' \
          --region ${{ secrets.AWS_REGION }}