name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::274363548500:role/githubactions-s3oidcrole
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ðŸ§ª Clone repo on EC2 via SSM
        env:
          INSTANCE_ID: i-0ebb50246a4b9c539
          REGION: ${{ secrets.AWS_REGION }}
        run: |
          cat > test-clone.json <<'JSON'
          {
            "commands": [
              "echo '== prepare workspace ==' && mkdir -p /home/ec2-user && cd /home/ec2-user",
              "echo '== clone fresh repo ==' && rm -rf medical-insurance-ec2 && git clone https://github.com/maniteja-gajminkar/medical-insurance-ec2.git",
              "cd medical-insurance-ec2",
              "echo '== list files ==' && ls -la"
            ]
          }
          JSON

          CMD_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids "$INSTANCE_ID" \
            --comment "Test repo clone and file listing" \
            --parameters file://test-clone.json \
            --region "$REGION" \
            --query "Command.CommandId" --output text)

          echo "SSM CommandId: $CMD_ID"
          aws ssm wait command-executed --command-id "$CMD_ID" --instance-id "$INSTANCE_ID" --region "$REGION"

          echo "----- Repo contents -----"
          aws ssm get-command-invocation \
            --command-id "$CMD_ID" \
            --instance-id "$INSTANCE_ID" \
            --region "$REGION" \
            --query '{Status:Status, StandardOutput:StandardOutputContent, StandardError:StandardErrorContent}' --output json